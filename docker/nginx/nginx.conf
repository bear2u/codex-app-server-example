worker_processes auto;

events {
  worker_connections 1024;
}

http {
  include /etc/nginx/mime.types;
  default_type application/octet-stream;

  sendfile on;
  keepalive_timeout 65;

  upstream web_ui_upstream {
    server web-ui:3000;
  }

  upstream codex_app_server_upstream {
    server codex-app-server:4000;
  }

  map $http_upgrade $connection_upgrade {
    default upgrade;
    "" close;
  }

  server {
    listen 80 default_server;
    server_name localhost 127.0.0.1;

    location = /healthz {
      add_header Content-Type text/plain;
      return 200 "ok\n";
    }

    location = /v1/events {
      proxy_pass http://codex_app_server_upstream/v1/events;
      proxy_http_version 1.1;
      proxy_set_header Host $host;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;
      proxy_set_header X-Codex-Can-Manage-Tunnel true;
      proxy_set_header Connection "";
      proxy_buffering off;
      proxy_cache off;
      chunked_transfer_encoding off;
      proxy_read_timeout 1h;
    }

    location ^~ /v1/ {
      proxy_pass http://codex_app_server_upstream;
      proxy_http_version 1.1;
      proxy_set_header Host $host;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;
      proxy_set_header X-Codex-Can-Manage-Tunnel true;
    }

    location / {
      proxy_pass http://web_ui_upstream;
      proxy_http_version 1.1;
      proxy_set_header Host $host;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;
      proxy_set_header Upgrade $http_upgrade;
      proxy_set_header Connection $connection_upgrade;
    }
  }

  server {
    listen 80;
    server_name ~^(?!localhost$)(?!127\.0\.0\.1$)(?!::1$).+;

    location = /_tunnel_session_check {
      internal;
      proxy_pass http://codex_app_server_upstream/v1/tunnel/public/session/check;
      proxy_http_version 1.1;
      proxy_pass_request_body off;
      proxy_set_header Content-Length "";
      proxy_set_header Cookie $http_cookie;
      proxy_set_header Host $host;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;
      proxy_set_header X-Codex-Can-Manage-Tunnel false;
    }

    location @tunnel_login_redirect {
      return 302 https://$host/tunnel-login?next=$uri;
    }

    location @tunnel_login_redirect_api {
      return 302 https://$host/tunnel-login?next=/;
    }

    location ^~ /_next/ {
      proxy_pass http://web_ui_upstream;
      proxy_http_version 1.1;
      proxy_set_header Host $host;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;
      proxy_set_header Upgrade $http_upgrade;
      proxy_set_header Connection $connection_upgrade;
    }

    location = /favicon.ico {
      proxy_pass http://web_ui_upstream/favicon.ico;
      proxy_http_version 1.1;
      proxy_set_header Host $host;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;
    }

    location ^~ /tunnel-login {
      proxy_pass http://web_ui_upstream;
      proxy_http_version 1.1;
      proxy_set_header Host $host;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;
      proxy_set_header Upgrade $http_upgrade;
      proxy_set_header Connection $connection_upgrade;
    }

    location ^~ /v1/tunnel/public/ {
      proxy_pass http://codex_app_server_upstream;
      proxy_http_version 1.1;
      proxy_set_header Host $host;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;
      proxy_set_header X-Codex-Can-Manage-Tunnel false;
    }

    location = /v1/tunnel/admin/state {
      proxy_pass http://codex_app_server_upstream/v1/tunnel/admin/state;
      proxy_http_version 1.1;
      proxy_set_header Host $host;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;
      proxy_set_header X-Codex-Can-Manage-Tunnel false;
    }

    location ^~ /v1/tunnel/admin/ {
      return 403;
    }

    location = /v1/events {
      auth_request /_tunnel_session_check;
      error_page 401 = @tunnel_login_redirect_api;

      proxy_pass http://codex_app_server_upstream/v1/events;
      proxy_http_version 1.1;
      proxy_set_header Host $host;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;
      proxy_set_header X-Codex-Can-Manage-Tunnel false;
      proxy_set_header Connection "";
      proxy_buffering off;
      proxy_cache off;
      chunked_transfer_encoding off;
      proxy_read_timeout 1h;
    }

    location ^~ /v1/ {
      auth_request /_tunnel_session_check;
      error_page 401 = @tunnel_login_redirect_api;

      proxy_pass http://codex_app_server_upstream;
      proxy_http_version 1.1;
      proxy_set_header Host $host;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;
      proxy_set_header X-Codex-Can-Manage-Tunnel false;
    }

    location / {
      auth_request /_tunnel_session_check;
      error_page 401 = @tunnel_login_redirect;

      proxy_pass http://web_ui_upstream;
      proxy_http_version 1.1;
      proxy_set_header Host $host;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;
      proxy_set_header Upgrade $http_upgrade;
      proxy_set_header Connection $connection_upgrade;
    }
  }
}
