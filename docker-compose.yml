services:
  codex-app-server:
    build:
      context: .
      dockerfile: docker/codex-app-server.Dockerfile
    container_name: codex-app-server
    restart: unless-stopped
    expose:
      - "4000"
    environment:
      NODE_ENV: production
      HOST: 0.0.0.0
      PORT: 4000
      CORS_ORIGIN: http://localhost:3000,http://127.0.0.1:3000
      CODEX_BIN: codex
      CODEX_CWD: ${CODEX_CWD:-/workspace}
      CODEX_MODEL: ${CODEX_MODEL:-gpt-5.3-codex}
      CODEX_APPROVAL_POLICY: ${CODEX_APPROVAL_POLICY:-on-request}
      CODEX_WRITABLE_ROOTS: ${CODEX_WRITABLE_ROOTS:-/workspace}
      CODEX_NETWORK_ACCESS: ${CODEX_NETWORK_ACCESS:-true}
      HTTP_BODY_LIMIT_MB: ${HTTP_BODY_LIMIT_MB:-20}
      SSE_HEARTBEAT_MS: ${SSE_HEARTBEAT_MS:-15000}
      THREAD_MESSAGES_PAGE_SIZE: ${THREAD_MESSAGES_PAGE_SIZE:-10}
      TUNNEL_COMMAND: ${TUNNEL_COMMAND:-ngrok}
      TUNNEL_PROVIDER_HOST: ${TUNNEL_PROVIDER_HOST:-https://ngrok.app}
      NGROK_AUTHTOKEN: ${NGROK_AUTHTOKEN:-}
      TUNNEL_LOCAL_HOST: ${TUNNEL_LOCAL_HOST:-nginx}
      TUNNEL_LOCAL_PORT: ${TUNNEL_LOCAL_PORT:-80}
      TUNNEL_START_TIMEOUT_MS: ${TUNNEL_START_TIMEOUT_MS:-12000}
      TUNNEL_SESSION_COOKIE_NAME: ${TUNNEL_SESSION_COOKIE_NAME:-codex_tunnel_session}
      TUNNEL_LOGIN_DELAY_MS: ${TUNNEL_LOGIN_DELAY_MS:-500}
      TUNNEL_LOGIN_JITTER_MS: ${TUNNEL_LOGIN_JITTER_MS:-250}
    volumes:
      - ./:/workspace
      - ${CODEX_HOME_MOUNT:-codex_home}:/root/.codex
    healthcheck:
      test:
        [
          "CMD",
          "node",
          "-e",
          "fetch('http://127.0.0.1:4000/healthz').then((r)=>process.exit(r.ok?0:1)).catch(()=>process.exit(1))",
        ]
      interval: 10s
      timeout: 3s
      retries: 10
      start_period: 20s

  web-ui:
    build:
      context: .
      dockerfile: docker/web-ui.Dockerfile
    container_name: web-ui
    restart: unless-stopped
    depends_on:
      codex-app-server:
        condition: service_healthy
    expose:
      - "3000"
    environment:
      NODE_ENV: production
    healthcheck:
      test:
        [
          "CMD",
          "node",
          "-e",
          "fetch('http://127.0.0.1:3000').then((r)=>process.exit(r.ok?0:1)).catch(()=>process.exit(1))",
        ]
      interval: 10s
      timeout: 3s
      retries: 10
      start_period: 20s

  nginx:
    build:
      context: .
      dockerfile: docker/nginx/Dockerfile
    container_name: codex-nginx
    restart: unless-stopped
    depends_on:
      codex-app-server:
        condition: service_healthy
      web-ui:
        condition: service_healthy
    ports:
      - "3000:80"
    healthcheck:
      test: ["CMD-SHELL", "wget -q -O - http://127.0.0.1/healthz >/dev/null 2>&1 || exit 1"]
      interval: 10s
      timeout: 3s
      retries: 10
      start_period: 20s

volumes:
  codex_home:
