services:
  codex-app-server:
    build:
      context: .
      dockerfile: docker/codex-app-server.Dockerfile
    container_name: codex-app-server
    restart: unless-stopped
    ports:
      - "4000:4000"
    environment:
      NODE_ENV: production
      HOST: 0.0.0.0
      PORT: 4000
      CORS_ORIGIN: http://localhost:3000,http://127.0.0.1:3000
      CODEX_BIN: codex
      CODEX_CWD: ${CODEX_CWD:-/workspace}
      CODEX_MODEL: ${CODEX_MODEL:-gpt-5.2-codex}
      CODEX_APPROVAL_POLICY: ${CODEX_APPROVAL_POLICY:-on-request}
      CODEX_WRITABLE_ROOTS: ${CODEX_WRITABLE_ROOTS:-/workspace}
      CODEX_NETWORK_ACCESS: ${CODEX_NETWORK_ACCESS:-true}
      HTTP_BODY_LIMIT_MB: ${HTTP_BODY_LIMIT_MB:-20}
      SSE_HEARTBEAT_MS: ${SSE_HEARTBEAT_MS:-15000}
      THREAD_MESSAGES_PAGE_SIZE: ${THREAD_MESSAGES_PAGE_SIZE:-10}
    volumes:
      - ./:/workspace
      - codex_home:/root/.codex
    healthcheck:
      test:
        [
          "CMD",
          "node",
          "-e",
          "fetch('http://127.0.0.1:4000/healthz').then((r)=>process.exit(r.ok?0:1)).catch(()=>process.exit(1))",
        ]
      interval: 10s
      timeout: 3s
      retries: 10
      start_period: 20s

  web-ui:
    build:
      context: .
      dockerfile: docker/web-ui.Dockerfile
    container_name: web-ui
    restart: unless-stopped
    depends_on:
      codex-app-server:
        condition: service_healthy
    ports:
      - "3000:3000"
    environment:
      NODE_ENV: production
      NEXT_PUBLIC_API_BASE_URL: http://localhost:4000

volumes:
  codex_home:
